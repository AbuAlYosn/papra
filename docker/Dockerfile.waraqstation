# WaraqStation - Arabic Document Management Platform
# محطة إدارة الوثائق العربية

# Base stage with pnpm and Arabic font support
FROM node:22-slim AS base

# Install system dependencies for Arabic text processing and OCR
RUN apt-get update && apt-get install -y \
    # Arabic fonts
    fonts-liberation \
    fonts-dejavu-core \
    fonts-noto-cjk \
    fonts-noto-color-emoji \
    fonts-amiri \
    fonts-aref-ruqaa \
    fonts-kacst \
    fonts-kacst-one \
    fonts-scheherazade-new \
    # OCR and image processing dependencies
    tesseract-ocr \
    tesseract-ocr-ara \
    tesseract-ocr-eng \
    libtesseract-dev \
    imagemagick \
    poppler-utils \
    # System utilities
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Configure ImageMagick for Arabic document processing
RUN sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN npm install -g corepack@latest
RUN corepack enable
RUN corepack prepare pnpm@10.12.3 --activate

# Build stage
FROM base AS build

WORKDIR /app

COPY pnpm-lock.yaml ./
COPY pnpm-workspace.yaml ./
COPY apps/papra-client/package.json apps/papra-client/package.json
COPY apps/papra-server/package.json apps/papra-server/package.json
COPY packages/webhooks/package.json packages/webhooks/package.json
COPY packages/lecture/package.json packages/lecture/package.json

RUN pnpm install --frozen-lockfile --ignore-scripts

COPY . .

# Build with Arabic locale support
RUN pnpm --filter "@waraqstation/app-client..." run build && \
    pnpm --filter "@waraqstation/app-server..." run build

RUN pnpm deploy --filter=@waraqstation/app-server --legacy --prod /prod/waraqstation-server

# Final stage
FROM base

WORKDIR /app

COPY --from=build /prod/waraqstation-server ./
COPY --from=build /app/apps/papra-client/dist ./public

# Create necessary directories
RUN mkdir -p ./app-data/db ./app-data/documents ./ingestion ./temp

# Set proper permissions for Arabic document processing
RUN chmod -R 755 ./app-data ./ingestion ./temp

EXPOSE 1221

# Environment variables for WaraqStation
ENV NODE_ENV=production
ENV SERVER_SERVE_PUBLIC_DIR=true
ENV DATABASE_URL=file:./app-data/db/waraqstation.sqlite
ENV DOCUMENT_STORAGE_FILESYSTEM_ROOT=./app-data/documents
ENV PAPRA_CONFIG_DIR=./app-data
ENV EMAILS_DRY_RUN=true
ENV CLIENT_BASE_URL=http://localhost:1221

# Arabic OCR configuration
ENV TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata
ENV OMP_THREAD_LIMIT=1

# Default to Arabic locale
ENV LANG=ar_SA.UTF-8
ENV LC_ALL=C.UTF-8

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:1221/health || exit 1

# Create a startup script for WaraqStation
RUN echo '#!/bin/bash\n\
echo "🚀 Starting WaraqStation - محطة إدارة الوثائق العربية"\n\
echo "📁 Arabic Document Management Platform"\n\
echo "🔧 Initializing database and running migrations..."\n\
pnpm migrate:up\n\
echo "✅ Database ready"\n\
echo "🌐 Starting server on port 1221"\n\
echo "📚 Access your WaraqStation at: http://localhost:1221"\n\
pnpm start' > /app/start-waraqstation.sh && \
    chmod +x /app/start-waraqstation.sh

CMD ["/app/start-waraqstation.sh"]

# Metadata
LABEL maintainer="WaraqStation Team"
LABEL description="WaraqStation - Arabic Document Management Platform"
LABEL version="1.0.0"
LABEL org.opencontainers.image.title="WaraqStation"
LABEL org.opencontainers.image.description="محطة إدارة الوثائق العربية - Arabic Document Management Platform"
LABEL org.opencontainers.image.vendor="WaraqStation"
LABEL org.opencontainers.image.version="1.0.0"